{%- assign uid = id_suffix | default: 'ps' -%}
{%- assign scroller_id_mobile = 'ps-' | append: uid | append: '-list' -%}
{%- assign scroller_id_desktop = 'ps-' | append: uid | append: '-desk' -%}
{%- assign btn_prev_id = 'ps-' | append: uid | append: '-prev' -%}
{%- assign btn_next_id = 'ps-' | append: uid | append: '-next' -%}

{%- assign _ps_count = products.size -%}
{%- if _ps_count == null -%}{%- assign _ps_count = products.count -%}{%- endif -%}
{%- if products and _ps_count > 0 -%}
  <section class="mt-[30px] md:mt-[90px]">
    <div class="container max-w-[var(--container)] mx-auto">
      <div class="flex items-center justify-center md:justify-between mb-[20px] md:mb-[50px]">
        {%- if title -%}
          <h2 class="w-full md:w-auto text-center md:text-left !text-[32px] md:!text-[48px] font-normal text-[#2E2E2D]">
            {{ title }}
          </h2>
        {%- endif -%}
        <!-- Desktop arrows -->
        <div class="hidden md:flex items-center gap-2">
          <button
            id="{{ btn_prev_id }}"
            class="group ps-arrow h-9 w-9 rounded-full border border-gray-300 bg-white grid place-items-center transition-colors hover:bg-[#647167] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#647167]/40"
            aria-label="Previous"
          >
            <svg viewBox="0 0 14 25" class="h-4 w-4 fill-[#647167] transition-colors group-hover:fill-white">
              <path d="M0.322 12.5c0 .285.109.57.326.787L11.777 24.416c.435.435 1.139.435 1.574 0s.435-1.139 0-1.574L3.009 12.5 13.351 2.158c.435-.435.435-1.139 0-1.574A1.111 1.111 0 0 0 11.777.585L.648 11.714A1.111 1.111 0 0 0 .322 12.5Z" />
            </svg>
          </button>
          <button
            id="{{ btn_next_id }}"
            class="group ps-arrow h-9 w-9 rounded-full border border-gray-300 bg-white grid place-items-center transition-colors hover:bg-[#647167] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#647167]/40"
            aria-label="Next"
          >
            <svg viewBox="0 0 14 25" class="h-4 w-4 fill-[#647167] transition-colors group-hover:fill-white rotate-180">
              <path d="M0.322 12.5c0 .285.109.57.326.787L11.777 24.416c.435.435 1.139.435 1.574 0s.435-1.139 0-1.574L3.009 12.5 13.351 2.158c.435-.435.435-1.139 0-1.574A1.111 1.111 0 0 0 11.777.585L.648 11.714A1.111 1.111 0 0 0 .322 12.5Z" />
            </svg>
          </button>
        </div>
      </div>

      <div class="relative mb-[10px] md:mb-[0px]">
        {%- assign initial_count = 1 -%}

        <!-- MOBILE LIST (unchanged) -->
        <ul id="{{ scroller_id_mobile }}" class="grid grid-cols-1 md:hidden gap-[15px]">
          {%- for p in products -%}
            <li
              class="{% if forloop.index > initial_count %}hidden{% endif %}"
              {% if forloop.index > initial_count %}
                data-more-item="true"
              {% endif %}
            >
              {% render 'product-slider-card', p: p, mode: 'mobile' %}
            </li>
          {%- endfor -%}
        </ul>
        <div class="md:hidden">
          {% render 'load-more', target_id: scroller_id_mobile, initial: initial_count, step: 4 %}
        </div>

        <!-- DESKTOP LIST (visible only â‰¥ md) -->
        <ul
          id="{{ scroller_id_desktop }}"
          class="hidden md:flex gap-[20px] overflow-x-auto scroll-smooth no-scrollbar"
          aria-label="Produktkarussell"
        >
          {%- for p in products -%}
            <li class="flex-none md:basis-[calc((100%-40px)/3)] xl:basis-[calc((100%-60px)/4)]">
              {% render 'product-slider-card', p: p, mode: 'desktop' %}
            </li>
          {%- endfor -%}
        </ul>
      </div>
    </div>
  </section>

  <style>
    /* optional: hide scrollbar visually for desktop carousel */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>

  <script>
    (function () {
      // DESKTOP horizontal scroll with arrows
      (function () {
        const scroller = document.getElementById('{{ scroller_id_desktop }}');
        const prevBtn = document.getElementById('{{ btn_prev_id }}');
        const nextBtn = document.getElementById('{{ btn_next_id }}');
        if (!scroller || !prevBtn || !nextBtn) return;

        const item = () => scroller.querySelector('li');
        const getGap = () => {
          const style = window.getComputedStyle(scroller);
          const gap = parseFloat(style.columnGap || style.gap || '0');
          return Number.isFinite(gap) ? gap : 0;
        };
        const step = () => {
          const el = item();
          if (!el) return 300;
          const rect = el.getBoundingClientRect();
          return Math.ceil(rect.width + getGap());
        };

        function updateDisabled() {
          const maxScrollLeft = scroller.scrollWidth - scroller.clientWidth - 1;
          prevBtn.disabled = scroller.scrollLeft <= 0;
          nextBtn.disabled = scroller.scrollLeft >= maxScrollLeft;
          prevBtn.classList.toggle('opacity-40', prevBtn.disabled);
          nextBtn.classList.toggle('opacity-40', nextBtn.disabled);
        }

        prevBtn.addEventListener('click', () => {
          scroller.scrollBy({ left: -step(), behavior: 'smooth' });
        });
        nextBtn.addEventListener('click', () => {
          scroller.scrollBy({ left: step(), behavior: 'smooth' });
        });
        scroller.addEventListener('scroll', updateDisabled);
        window.addEventListener('resize', updateDisabled);
        updateDisabled();
      })();
    })();
  </script>
{%- endif -%}
