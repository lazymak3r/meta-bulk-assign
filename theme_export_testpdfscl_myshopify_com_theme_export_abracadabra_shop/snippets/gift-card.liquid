<!-- Gift Card – Fixed Card (no product lookup) -->
{{ 'product-card.css' | asset_url | stylesheet_tag }}
{{ 'gift-card.css' | asset_url | stylesheet_tag }}

{% assign gift_product = products | first %}
{% if gift_product %}
{% assign v25 = gift_product.variants | where: 'price', 2500 | first %}
{% assign v50 = gift_product.variants | where: 'price', 5000 | first %}
{% assign v100 = gift_product.variants | where: 'price', 10000 | first %}
{% assign v200 = gift_product.variants | where: 'price', 20000 | first %}
{% assign v500 = gift_product.variants | where: 'price', 50000 | first %}
{% endif %}

<article class="gc-card pcard h-full flex flex-col relative" data-gc
  data-product-id="{{ gift_product.id | default: '' }}" data-product-handle="{{ gift_product.handle | default: '' }}"
  data-variant-id="">
  <!-- Media -->
  <div class="gc-media pcard-media">
    {% if gift_product and gift_product.featured_image %}
    <img class="gc-img absolute inset-0 w-full h-full" src="{{ gift_product.featured_image | image_url: width: 1200 }}"
      alt="{{ gift_product.featured_image.alt | default: gift_product.title | escape }}" loading="lazy" width="1200"
      height="800">
    {% else %}
    <div class="gc-media-fallback" aria-hidden="true"></div>
    {% endif %}
  </div>

  <!-- Ribbon positioned relative to the entire card -->
  <div class="gc-ribbon" aria-hidden="true">
    <img src="{{ 'gift-card-ribbon.svg' | asset_url }}" alt="Gift card ribbon" width="222" height="277">
  </div>

  <!-- Body -->
  <div class="gc-body pcard-body isolate grow flex flex-col">
    <div class="gc-brand">
      <img src="{{ 'default-logo.png' | asset_url }}" alt="Roomio" width="120" height="40">
    </div>

    <h3 class="gc-title">Geschenkkarte</h3>
    <p class="gc-desc">Schenken Sie die Wahl mit unserer exklusiven Geschenkkarte!</p>

    <!-- Amount pills -->
    <div class="gc-amounts" role="group" aria-label="Betrag wählen">
      <button type="button" class="gc-amount is-selected" data-label="25,- €" data-price="25"
        data-variant-id="{{ v25.id | default: '' }}">
        25 €
      </button>
      <button type="button" class="gc-amount" data-label="50,- €" data-price="50"
        data-variant-id="{{ v50.id | default: '' }}">
        50 €
      </button>
      <button type="button" class="gc-amount" data-label="100 €" data-price="100"
        data-variant-id="{{ v100.id | default: '' }}">
        100 €
      </button>
      <button type="button" class="gc-amount" data-label="200 €" data-price="200"
        data-variant-id="{{ v200.id | default: '' }}">
        200 €
      </button>
      <button type="button" class="gc-amount" data-label="500 €" data-price="500"
        data-variant-id="{{ v500.id | default: '' }}">
        500 €
      </button>
    </div>

    <div class="mt-auto">
      <div class="mt-[16px] border-t border-[#C2C2C2]"></div>

      <div class="gc-learn">
        <button type="button" class="gc-link js-gc-open">Erfahren Sie mehr</button>
      </div>

      <div class="gc-footer">
        <div class="gc-price">
          <span class="gc-price-value">25,- €*</span>
        </div>

        <div class="gc-actions">
          <!-- Wishlist (CARD) -->
          <button type="button"
            class="favorite-btn grid place-items-center w-[32px] h-[30px] rounded-full border border-[#647167] transition focus:outline-none focus-visible:ring-2 focus-visible:ring-[#647167]"
            aria-label="Zu Favoriten hinzufügen" data-product-id="{{ gift_product.id }}"
            data-product-handle="{{ gift_product.handle }}" data-title="{{ gift_product.title | escape }}"
            data-image="{{ gift_product.featured_image | image_url: width: 600 }}" data-url="{{ gift_product.url }}"
            data-variant-id="">
            {% comment %}heart icon{% endcomment %}
            <svg width="18" height="15" viewBox="0 0 18 15" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M9.246 13.6843C8.974 13.7719 8.526 13.7719 8.254 13.6843C5.934 12.9612 0.75 9.94494 0.75 4.83258C0.75 2.57584 2.742 0.75 5.198 0.75C6.654 0.75 7.942 1.3927 8.75 2.38596C9.558 1.3927 10.854 0.75 12.302 0.75C14.758 0.75 16.75 2.57584 16.75 4.83258C16.75 9.94494 11.566 12.9612 9.246 13.6843Z"
                stroke="#647167" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>

          <!-- Add to cart (CARD) -->
          <button type="button"
            class="icon-btn icon-add-to-cart grid place-items-center w-[32px] h-[32px] rounded-full border border-[#647167] transition hover:bg-[#ECECEC] focus:outline-none focus-visible:ring-2 focus-visible:ring-[#647167]"
            aria-label="In den Warenkorb">
            <!-- cart icon -->
            <svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M0.75 0.75H1.72962C1.91414 0.75 2.00639 0.75 2.08064 0.78393C2.14606 0.813831 2.20151 0.861919 2.24036 0.922459C2.28445 0.991158 2.2975 1.08249 2.32359 1.26515L2.67857 3.75M2.67857 3.75L3.46749 9.54855C3.5676 10.2844 3.61766 10.6523 3.79357 10.9293C3.94858 11.1733 4.17081 11.3673 4.43352 11.488C4.73165 11.625 5.10296 11.625 5.84558 11.625H12.264C12.9709 11.625 13.3244 11.625 13.6132 11.4978C13.8679 11.3857 14.0864 11.2049 14.2442 10.9757C14.4232 10.7157 14.4893 10.3685 14.6216 9.67407L15.6143 4.46227C15.6609 4.21786 15.6842 4.09565 15.6504 4.00012C15.6208 3.91633 15.5624 3.84576 15.4857 3.80101C15.3981 3.75 15.2737 3.75 15.0249 3.75H2.67857ZM6.75 15C6.75 15.4142 6.41421 15.75 6 15.75C5.58579 15.75 5.25 15.4142 5.25 15C5.25 14.5858 5.58579 14.25 6 14.25C6.41421 14.25 6.75 14.5858 6.75 15ZM12.75 15C12.75 15.4142 12.4142 15.75 12 15.75C11.5858 15.75 11.25 15.4142 11.25 15C11.25 14.5858 11.5858 14.25 12 14.25C12.4142 14.25 12.75 14.5858 12.75 15Z"
                stroke="#647167" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="gc-modal" aria-hidden="true">
      <div class="gc-modal__backdrop"></div>
      <div class="gc-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="gcModalTitle">
        <button class="gc-modal__close js-gc-close" aria-label="Schließen">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M9.46585 8.01168L15.6959 1.7814C16.1014 1.37615 16.1014 0.720912 15.6959 0.315659C15.2907 -0.0895946 14.6354 -0.0895946 14.2302 0.315659L7.99991 6.54593L1.76983 0.315659C1.36438 -0.0895946 0.709336 -0.0895946 0.304082 0.315659C-0.101361 0.720912 -0.101361 1.37615 0.304082 1.7814L6.53416 8.01168L0.304082 14.2419C-0.101361 14.6472 -0.101361 15.3024 0.304082 15.7077C0.506045 15.9098 0.771595 16.0114 1.03695 16.0114C1.30232 16.0114 1.56768 15.9098 1.76983 15.7077L7.99991 9.47742L14.2302 15.7077C14.4323 15.9098 14.6977 16.0114 14.9631 16.0114C15.2284 16.0114 15.4938 15.9098 15.6959 15.7077C16.1014 15.3024 16.1014 14.6472 15.6959 14.2419L9.46585 8.01168Z"
              fill="#898989" />
          </svg>
        </button>

        <h3 id="gcModalTitle" class="gc-modal__title">Roomio-Marken-Geschenkkarte</h3>

        <div class="with-checks">
          <ul>
            <li>lose Rücken- und Sitzkissen</li>
            <li>nach Wunsch kombinierbar</li>
            <li>mit Stoffauswahl</li>
          </ul>
        </div>

        <div class="gc-modal__pills">
          <div class="gc-modal__pills-title">Konfessionen</div>
          <div class="gc-amounts">
            <button type="button" class="gc-amount is-selected" data-label="25,- €" data-price="25"
              data-variant-id="{{ v25.id | default: '' }}">
              25 €
            </button>
            <button type="button" class="gc-amount" data-label="50,- €" data-price="50"
              data-variant-id="{{ v50.id | default: '' }}">
              50 €
            </button>
            <button type="button" class="gc-amount" data-label="100 €" data-price="100"
              data-variant-id="{{ v100.id | default: '' }}">
              100 €
            </button>
            <button type="button" class="gc-amount" data-label="200 €" data-price="200"
              data-variant-id="{{ v200.id | default: '' }}">
              200 €
            </button>
            <button type="button" class="gc-amount" data-label="500 €" data-price="500"
              data-variant-id="{{ v500.id | default: '' }}">
              500 €
            </button>
          </div>
        </div>

        <div class="gc-modal__bar">
          <div class="gc-modal__price">
            <span class="gc-price-prefix">ab</span>
            <span class="gc-price-value">25,- €*</span>
          </div>
          <div class="gc-modal__actions">
            <!-- Wishlist (MODAL) -->
            <button type="button"
              class="favorite-btn h-[50px] px-5 md:px-7 text-[16px] hover:bg-gray-50 transition-colors inline-flex items-center gap-2"
              aria-label="Zu Favoriten" data-product-id="{{ gift_product.id | default: '' }}"
              data-product-handle="{{ gift_product.handle | default: '' }}" data-variant-id="">
              Zu Favoriten
              <img src="{{ 'heart.svg' | asset_url }}" alt="Zu Favoriten" width="24" height="22">
            </button>

            <!-- Add to cart (MODAL via native form submit) -->
            <form method="post" action="{{ routes.cart_add_url }}" accept-charset="UTF-8" class="js-gc-form">
              <input type="hidden" name="id" value="{{ v25.id | default: '' }}">
              <input type="hidden" name="quantity" value="1">
              <button type="submit"
                class="btn-primary px-4 sm:px-5 md:px-7 flex gap-[10px] h-[50px] items-center justify-center"
                aria-label="In den Warenkorb">
                <span class="text-[16px]">In den Warenkorb</span>
                <svg width="25" height="24" viewBox="0 0 25 24" fill="none" aria-hidden="true">
                  <path
                    d="M18.6776 17.8448C17.1362 17.8433 15.8854 19.0916 15.8839 20.633C15.8824 22.1744 17.1308 23.4252 18.6722 23.4267C20.2136 23.4282 21.4643 22.1798 21.4658 20.6384Z"
                    fill="white" />
                  <path
                    d="M23.6278 4.48019H6.43181L6.16267 2.66004C5.99499 1.46427 4.97216 0.574219 3.76466 0.574219H1.57655C0.981978 0.574219 0.5 1.0562 0.5 1.65077C0.5 2.24534 0.981978 2.72732 1.57655 2.72732H3.76735L5.69436 14.3272C5.92166 15.771 7.16363 16.8362 8.62529 16.8409H19.8241C21.2313 16.8428 22.4454 15.8537 22.7281 14.4752L24.4802 5.74167C24.5932 5.15792 24.2115 4.59315 23.6278 4.48019Z"
                    fill="white" />
                  <path
                    d="M11.8404 20.5162C11.7749 19.02 10.5401 17.8423 9.04245 17.8475C7.50232 17.9097 6.30423 19.2087 6.36647 20.7488C6.42619 22.2266 7.62832 23.4012 9.10705 23.4267H9.17434C10.7143 23.3592 11.9079 22.0562 11.8404 20.5162Z"
                    fill="white" />
                </svg>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</article>

<script>
  (function () {
    const root = document.querySelector('[data-gc]');
    if (!root) return;

    const modal = root.querySelector('.gc-modal');
    const dialog = modal?.querySelector('.gc-modal__dialog');
    const openBtn = root.querySelector('.js-gc-open');
    const closeEls = root.querySelectorAll('.js-gc-close, .gc-modal__backdrop');
    let modalOriginalParent = modal?.parentElement || null;
    let modalPlaceholder = null;

    const priceElCard = root.querySelector(':scope > .pcard-body .gc-price-value');
    const priceElModal = modal?.querySelector('.gc-price-value');

    const addToCartButtons = Array.from(root.querySelectorAll('.icon-add-to-cart'));
    const favoriteButtons = Array.from(root.querySelectorAll('.favorite-btn'));

    const cardPills = Array.from(root.querySelectorAll(':scope > .pcard-body .gc-amounts .gc-amount'));
    const modalPills = modal ? Array.from(modal.querySelectorAll('.gc-amounts .gc-amount')) : [];

    function formatPriceForScope(n) {
      if (typeof formatEuro === 'function') return formatEuro(n, { isCents: false });
      return `${n},- €*`;
    }

    // set all likely names so any wishlist impl picks it up
    function setVariantAttributesOn(el, vid) {
      if (!el) return;
      el.dataset.variantId = vid || '';
      el.dataset.variant = vid || '';
      el.dataset.id = vid || '';
    }

    function pushVariantToButtons(vid) {
      addToCartButtons.forEach((btn) => setVariantAttributesOn(btn, vid));
      favoriteButtons.forEach((btn) => setVariantAttributesOn(btn, vid));
      root.setAttribute('data-variant-id', vid || '');
      // keep modal native form in sync
      try {
        const idInput = modal?.querySelector('.js-gc-form input[name="id"]');
        if (idInput) idInput.value = vid || '';
      } catch (e) {
        console.error('[GC] pushVariantToButtons failed', e);
      }
    }

    // If Liquid couldn't resolve variant ids, hydrate them from product JSON
    async function hydrateVariantIdsIfMissing() {
      const need = [...cardPills, ...modalPills].some(
        (b) => !(b.dataset.variantId || b.dataset.variant || b.dataset.id)
      );
      const handle = root.getAttribute('data-product-handle');
      if (!need || !handle) return;
      try {
        const res = await fetch(`/products/${handle}.js`, { credentials: 'same-origin' });
        const prod = await res.json();
        const variants = Array.isArray(prod?.variants) ? prod.variants : [];
        const findByPrice = (priceNumber) => {
          const cents = Math.round(Number(priceNumber) * 100);
          return (
            variants.find((v) => Number(v?.price) === cents) ||
            variants.find((v) => String(v?.title || '').includes(String(priceNumber))) ||
            variants.find((v) => String(v?.option1 || '').includes(String(priceNumber))) ||
            null
          );
        };
        [...cardPills, ...modalPills].forEach((btn) => {
          if (btn.dataset.variantId) return;
          const p = Number(btn.dataset.price);
          const match = findByPrice(p);
          if (match?.id) setVariantAttributesOn(btn, String(match.id));
        });
        const firstVid =
          [...cardPills, ...modalPills].find((b) => b.dataset.variantId)?.dataset.variantId ||
          (variants[0] ? String(variants[0].id) : '');
        if (firstVid) pushVariantToButtons(firstVid);
      } catch (e) {
        console.warn('[GC] hydrateVariantIdsIfMissing failed', e);
      }
    }

    async function resolveVariantId() {
      const fromRoot = root.getAttribute('data-variant-id');
      if (fromRoot) return fromRoot;
      const selectedModal = modalPills.find((b) => b.classList.contains('is-selected'));
      const selectedCard = cardPills.find((b) => b.classList.contains('is-selected'));
      if (selectedModal?.dataset.variantId) return selectedModal.dataset.variantId;
      if (selectedCard?.dataset.variantId) return selectedCard.dataset.variantId;
      await hydrateVariantIdsIfMissing();
    }

    function setSelectedPill(pill, scope) {
      // blur any focused control inside the card to avoid sticky :focus styles on selection change
      try {
        const activeEl = document.activeElement;
        if (activeEl && root.contains(activeEl) && typeof activeEl.blur === 'function') {
          activeEl.blur();
        }
      } catch (_) { }

      // selection
      cardPills.forEach((b) => b.classList.remove('is-selected'));
      modalPills.forEach((b) => b.classList.remove('is-selected'));
      pill.classList.add('is-selected');
      const peers = scope === 'modal' ? cardPills : modalPills;
      const match = peers.find((b) => b.dataset.price === pill.dataset.price);
      match?.classList.add('is-selected');

      // price UI
      const n = Number(pill.dataset.price);
      if (priceElCard) priceElCard.textContent = formatPriceForScope(n);
      if (priceElModal) priceElModal.textContent = formatPriceForScope(n);

      const vid = pill.getAttribute('data-variant-id') || '';
      pushVariantToButtons(vid);
    }

    function syncSelection(fromScope, toScope) {
      const from = fromScope === 'modal' ? modalPills : cardPills;
      const to = toScope === 'modal' ? modalPills : cardPills;
      const selected = from.find((b) => b.classList.contains('is-selected'));
      if (!selected) return;
      const counterpart = to.find((b) => b.dataset.price === selected.dataset.price);
      if (counterpart) setSelectedPill(counterpart, toScope);
    }

    // Init (also ensures buttons get initial variant)
    const initial = cardPills.find((b) => b.classList.contains('is-selected')) || cardPills[0];
    if (initial) setSelectedPill(initial, 'card');
    hydrateVariantIdsIfMissing();

    // Clicks
    cardPills.forEach((btn) =>
      btn.addEventListener('click', () => {
        setSelectedPill(btn, 'card');
        if (modal) syncSelection('card', 'modal');
      })
    );
    modalPills.forEach((btn) =>
      btn.addEventListener('click', () => {
        setSelectedPill(btn, 'modal');
        syncSelection('modal', 'card');
      })
    );

    // Modal open/close
    function openModal() {
      if (!modal) return;
      // Port modal to body so it's centered relative to the viewport
      if (!modal.__portedToBody) {
        try {
          modalPlaceholder = document.createElement('span');
          modalPlaceholder.setAttribute('data-gc-modal-placeholder', '');
          modalPlaceholder.style.display = 'none';
          if (modalOriginalParent) modalOriginalParent.insertBefore(modalPlaceholder, modal);
          document.body.appendChild(modal);
          modal.__portedToBody = true;
        } catch (e) {
          console.error('[GC] openModal failed', e);
        }
      }
      root.classList.add('gc-open');
      modal.setAttribute('aria-hidden', 'false');
      syncSelection('card', 'modal');
      // Ensure variant ids are hydrated when opening
      hydrateVariantIdsIfMissing();
    }
    function closeModal() {
      if (!modal) return;
      root.classList.remove('gc-open');
      modal.setAttribute('aria-hidden', 'true');
      // Restore modal back to original position in DOM
      if (modal.__portedToBody) {
        try {
          if (modalOriginalParent && modalPlaceholder && modalPlaceholder.parentNode) {
            modalOriginalParent.insertBefore(modal, modalPlaceholder);
            modalPlaceholder.remove();
          }
        } catch (e) {
          console.error('[GC] closeModal failed', e);
        }
        modal.__portedToBody = false;
      }
    }

    openBtn?.addEventListener('click', openModal);
    closeEls.forEach((el) => el.addEventListener('click', closeModal));
    dialog?.addEventListener('mousedown', (e) => e.stopPropagation());
    dialog?.addEventListener('click', (e) => e.stopPropagation());
    modal?.addEventListener('mousedown', (e) => {
      if (dialog && !dialog.contains(e.target)) closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal?.getAttribute('aria-hidden') === 'false') closeModal();
    });

    favoriteButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const payload = {
          productId: btn.dataset.productId,
          handle: btn.dataset.productHandle,
          variantId: btn.dataset.variantId || btn.dataset.variant || btn.dataset.id,
          title: btn.dataset.title,
          image: btn.dataset.image,
          url: btn.dataset.url,
        };
        console.debug('[wishlist payload]', payload);
        if (!payload.variantId) {
          console.warn('No variantId on favorite button – check Liquid (data-variant-id on pills) or price mapping.');
        }
      });
    });

    // --- Add to cart (card + modal) using a stable fetch path ---
    function addVariantToCart(variantId) {
      if (!variantId) {
        console.warn('[GC ATC] No variant selected');
        return Promise.resolve();
      }
      const payload =
        typeof buildSectionsPayload === 'function'
          ? { id: variantId, quantity: 1, ...buildSectionsPayload() }
          : { id: variantId, quantity: 1, sections_url: window.location.pathname + window.location.search };
      return fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(payload),
      })
        .then(async (r) => {
          // Shopify returns 200 with JSON on success; on error it may return 422 with errors
          const data = await r.json();
          if (!r.ok) throw new Error(data?.description || 'Add to cart failed');
          return data;
        })
        .then((data) => {
          try {
            if (data.sections) updateSections && updateSections(data.sections);
          } catch (_) { }
          try {
            updateCartInfo && updateCartInfo();
          } catch (_) { }
          try {
            showMiniCartPopover && showMiniCartPopover();
          } catch (_) { }
        })
        .catch((err) => console.error('[GC ATC] failed', err));
    }

    function bindATC(btn) {
      if (!btn || btn.__gcAtcBound) return;
      btn.__gcAtcBound = true;
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        let vid = btn.dataset.variantId || root.getAttribute('data-variant-id') || '';
        if (!vid) vid = await resolveVariantId();
        btn.disabled = true;
        addVariantToCart(vid).finally(() => {
          try {
            btn.blur && btn.blur();
          } catch (e) {
            console.error('[GC ATC] failed', e);
          }
          btn.disabled = false;
        });
      });
    }

    // Only bind JS ATC for card buttons (modal uses native form submit)
    addToCartButtons.forEach(bindATC);
  })();
</script>