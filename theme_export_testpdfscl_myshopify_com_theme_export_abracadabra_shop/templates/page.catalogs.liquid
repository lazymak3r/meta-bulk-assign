{% render 'breadcrumbs', current_title: 'sections.catalogs.title' %}

{{ 'page-catalogs.css' | asset_url | stylesheet_tag }}

<div class="catalogs-page-wrapper">
  <h1 class="catalogs-title">{{ 'sections.catalogs.title' | t: default: page.title }}</h1>

  <div id="catalogs-list" class="catalogs-grid" aria-live="polite"></div>

  <div class="catalogs-load-more" style="display: none;">
    <button id="catalogs-load-more"
      class="mt-6 w-full max-w-full mx-auto flex items-center gap-4 text-xs md:text-sm text-gray-500 hover:text-gray-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-gray-300"
      aria-live="polite"
      data-load-more-label="{{- 'sections.category_products_grid.load_more' | t: default: 'Mehr laden' -}}"
      data-loading-label="{{- 'sections.category_products_grid.loading_text' | t: default: 'Laden…' -}}">
      <span class="h-px grow bg-[#BAB9B7]"></span>
      <span class="shrink-0 text-black text-[20px]">
        <span class="btn-label">{{- 'sections.category_products_grid.load_more' | t: default: 'Mehr laden' -}}</span>
        <span class="btn-loading hidden items-center gap-2">
          <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity=".25" />
            <path d="M22 12a10 10 0 0 1-10 10" stroke="currentColor" stroke-width="4" stroke-linecap="round" />
          </svg>
          <span>{{ 'sections.category_products_grid.loading_text' | t: default: 'Laden…' }}</span>
        </span>
      </span>
      <span class="h-px grow bg-[#BAB9B7]"></span>
    </button>
  </div>

</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const container = document.getElementById('catalogs-list');
    const loadMoreBtn = document.getElementById('catalogs-load-more');
    const loadMoreWrapper = document.querySelector('.catalogs-load-more');
    const PAGE_SIZE = 4;
    let allItems = [];
    let visibleCount = 0;

    function render() {
      const slice = allItems.slice(0, visibleCount);
      container.innerHTML = slice
        .map((item, idx) => {
          const downloadUrl = item.pdf_url || item.pdf || '';
          return `
      <div class="catalog-card">
        <img src="${item.cover}" alt="${item.name}" />
        
        <div class="catalog-card__body">
          <div class="catalog-card__title">${item.name || `Katalog ${idx + 1}`}</div>
          <div class="catalog-card__actions">
            ${downloadUrl
              ? `<a class="icon-btn" href="#" data-download-url="${downloadUrl}" data-filename="${(
                item.name || `Katalog ${idx + 1}`
              ).replace(/"/g, '')}.pdf" aria-label="{{ 'sections.catalogs.download' | t }}"><img src="{{ 'download.svg' | asset_url }}" width="24" height="24" alt="" aria-hidden="true"></a>`
              : `<span class="icon-btn icon-btn--disabled" aria-hidden="true"><img src="{{ 'download.svg' | asset_url }}" width="24" height="24" alt=""></span>`
            }
            <a class="icon-btn" href="/pages/bestellungen" aria-label="Kontakt">
              <img src="{{ 'post.svg' | asset_url }}" width="24" height="24" alt="" aria-hidden="true">
            </a>
            <a class="btn-primary" href="/pages/catalog?id=${item.id}">{{ 'sections.catalogs.browse' | t }}<span class="ml-2 inline-flex"><img src="{{ 'eye.svg' | asset_url }}" width="24" height="24" alt="" aria-hidden="true"></span></a>
          </div>
        </div>
      </div>`;
        })
        .join('');

      if (visibleCount >= allItems.length) {
        if (loadMoreWrapper) loadMoreWrapper.style.display = 'none';
      } else {
        if (loadMoreWrapper) loadMoreWrapper.style.display = '';
      }
    }

    function showMore() {
      // toggle loading UI like category button
      const btn = document.getElementById('catalogs-load-more');
      const label = btn?.querySelector('.btn-label');
      const loading = btn?.querySelector('.btn-loading');
      if (btn && label && loading) {
        label.classList.add('hidden');
        loading.classList.remove('hidden');
      }

      setTimeout(() => {
        visibleCount = Math.min(visibleCount + PAGE_SIZE, allItems.length);
        render();
        if (btn && label && loading) {
          loading.classList.add('hidden');
          label.classList.remove('hidden');
        }
      }, 150);
    }

    try {
      const res = await fetch('{{ settings.api_host }}/api/public/ecatalog/catalogs/{{ shop.domain }}/list');
      const payload = await res.json();
      allItems = Array.isArray(payload?.data) ? payload.data : [];
      visibleCount = Math.min(PAGE_SIZE, allItems.length);
      render();
    } catch (err) {
      container.innerHTML = `<p>{{ 'general.404.body' | t }}</p>`;
      if (loadMoreWrapper) loadMoreWrapper.style.display = 'none';
    }

    loadMoreBtn.addEventListener('click', showMore);

    // Delegated download handler to support S3 cross-origin downloads
    container.addEventListener('click', async (e) => {
      const a = e.target.closest('a.icon-btn[data-download-url]');
      if (!a) return;
      e.preventDefault();
      const fileUrl = a.getAttribute('data-download-url');
      window.location.href = fileUrl;
    });
  });
</script>