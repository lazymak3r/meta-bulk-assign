{{ 'login.css' | asset_url | stylesheet_tag }}

<div class="recover-modal-overlay is-open">
  <div
    class="recover-modal reset-password-modal"
    role="dialog"
    aria-labelledby="reset-title"
    aria-modal="true">
    <button
      type="button"
      class="recover-close"
      aria-label="Close"
      onclick="window.location='{{ routes.account_login_url }}'"></button>
    {% form 'reset_customer_password' %}
      {% if form.errors %}
        <div class="errors">{{ form.errors | default_errors }}</div>
      {% endif %}

      <h1 id="reset-title" class="recover-title">Neues Passwort festlegen</h1>
      <p class="reset-subtitle">Mindestens 8 Zeichen, Groß- und Kleinbuchstaben, Zahl oder Symbol</p>

      <div class="flex flex-col gap-[34px]">
        <div class="field">
          <input
            type="password"
            name="customer[password]"
            id="password"
            required
            placeholder="Neues Passwort"
            class="recover-input"
            autocomplete="new-password"
            aria-label="Neues Passwort">
          <button
            type="button"
            class="toggle-visibility"
            data-target="password"
            aria-label="Passwort anzeigen">
            <img
              src="{{ 'placeholder-eye.svg' | asset_url }}"
              width="22"
              height="20"
              alt=""
              aria-hidden="true">
          </button>
        </div>

        <div class="field">
          <input
            type="password"
            name="customer[password_confirmation]"
            id="password_confirmation"
            required
            placeholder="Passwort bestätigen"
            class="recover-input"
            autocomplete="new-password"
            aria-label="Passwort bestätigen">
          <button
            type="button"
            class="toggle-visibility"
            data-target="password_confirmation"
            aria-label="Passwort anzeigen">
            <img
              src="{{ 'placeholder-eye.svg' | asset_url }}"
              width="22"
              height="20"
              alt=""
              aria-hidden="true">
          </button>
        </div>
      </div>

      <div class="recover-actions">
        <a href="{{ routes.account_login_url }}" class="recover-cancel">Abbrechen</a>
        <button
          type="submit"
          class="btn-primary"
          id="reset-submit">Passwort speichern</button>
      </div>
    {% endform %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    var buttons = document.querySelectorAll('.toggle-visibility');
    buttons.forEach(function(btn){
      btn.addEventListener('click', function(){
        var input = document.getElementById(btn.getAttribute('data-target'));
        if (!input) return;
        input.type = input.type === 'password' ? 'text' : 'password';
      });
    });

    // Handle form submission to prevent redirect and show success message
    var form = document.querySelector('form[action*="reset"]');
    var submitBtn = document.getElementById('reset-submit');
    
    if (form && submitBtn) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.textContent = 'Speichern...';
        
        // Submit form data via fetch
        var formData = new FormData(form);
        
        fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => {
          if (response.ok) {
            var formContainer = form.parentElement;
            formContainer.innerHTML = `
              <div class="reset-success reset-success-ajax" role="dialog" aria-labelledby="reset-success-title" aria-live="polite">
                <h1 id="reset-success-title" class="recover-title">Passwort erfolgreich zurückgesetzt</h1>
                <p class="reset-subtitle">Ihr Passwort wurde erfolgreich geändert.<br>Sie können sich jetzt mit dem neuen Passwort anmelden.</p>
                <div class="recover-actions">
                  <a class="btn-primary" href="{{ routes.account_login_url }}">Zum Login</a>
                </div>
              </div>
            `;
          } else {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Passwort speichern';
            alert('Es gab einen Fehler beim Zurücksetzen des Passworts. Bitte versuchen Sie es erneut.');
          }
        })
        .catch(error => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Passwort speichern';
          alert('Es gab einen Fehler beim Zurücksetzen des Passworts. Bitte versuchen Sie es erneut.');
        });
      });
    }
  });
</script>